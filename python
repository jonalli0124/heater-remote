  GNU nano 8.4                                                                                                                                                                                                                           miles_daemon.py                                                                                                                                                                                                                                     
import time
import subprocess
import serial
import RPi.GPIO as GPIO
import paho.mqtt.client as mqtt
import base64
import os

# --- Configuration ---
AIO_USERNAME = "Jonalli0124"
AIO_KEY = "6c8ce060af344d95afc44350ecfd279d"

# Feed Names
T_HEATER = f"{AIO_USERNAME}/feeds/relay-heater"
T_TUNNEL = f"{AIO_USERNAME}/feeds/tunnel"
T_CAMERA = f"{AIO_USERNAME}/feeds/camera"
T_IP     = f"{AIO_USERNAME}/feeds/ip-address"
T_SIGNAL = f"{AIO_USERNAME}/feeds/signal"
T_TEMP1  = f"{AIO_USERNAME}/feeds/temp-1"
T_TEMP2  = f"{AIO_USERNAME}/feeds/temp-2"
T_TEMP3  = f"{AIO_USERNAME}/feeds/temp-3"

# Timing
HEARTBEAT_INTERVAL = 60          # 1 minute
PHOTO_INTERVAL = 4 * 60 * 60     # 4 hours

# GPIO Setup
RELAY_PIN = 17
GPIO.setwarnings(False)
GPIO.setmode(GPIO.BCM)
GPIO.setup(RELAY_PIN, GPIO.OUT)

# --- Helpers ---
def get_ssh_status():
    """Checks if cloudflared service is actually running."""
    try:
        status = subprocess.run(["systemctl", "is-active", "cloudflared"], capture_output=True, text=True)
        return "ON" if status.stdout.strip() == "active" else "OFF"
    except: return "OFF"

def capture_and_send_photo(client):
    print("ðŸ“¸ Capturing image (480p Low-Data)...")
    try:
        img_path = "/dev/shm/snap.jpg"
        # Optimized for cellular: 640x480 at 15% quality
        subprocess.run(["libcamera-jpeg", "-o", img_path, "-t", "500", "--width", "640", "--height", "480", "--quality", "15", "--immediate"])

        if os.path.exists(img_path):
            with open(img_path, "rb") as f:
                encoded = base64.b64encode(f.read()).decode('utf-8')

            if len(encoded) < 100000: # Adafruit's 100KB limit
                client.publish(T_CAMERA, encoded)
                print(f"ðŸ“¤ Photo Sent: {len(encoded)} bytes")
            else:
                print("âš ï¸ Error: Image too large for Adafruit IO")
            os.remove(img_path)
    except Exception as e:
        print(f"âŒ Camera Error: {e}")

def get_cellular_signal():
    try:
        ser = serial.Serial("/dev/ttyUSB2", 115200, timeout=1)
        ser.write(b'AT+CSQ\r\n')
        response = ser.read(100).decode()
        ser.close()
        if "+CSQ:" in response:
            csq = int(response.split(":")[1].split(",")[0].strip())
            return int((csq / 31) * 100) if csq != 99 else 0
        return 0
    except: return 0

def get_ip_address():
    try:
        return subprocess.check_output(["hostname", "-I"]).decode().split()[0]
    except: return "127.0.0.1"

def get_cpu_temp():
    try:
        with open("/sys/class/thermal/thermal_zone0/temp", "r") as f:
            return round((int(f.read()) / 1000.0 * 9/5) + 32, 1)
    except: return 0.0

# --- MQTT CALLBACKS ---
def on_connect(client, userdata, flags, rc, properties=None):
    print(f"âœ… Connected to Adafruit (Code: {rc})")
    for t in [T_HEATER, T_TUNNEL, T_CAMERA]: 
        client.subscribe(t)
    
    # INITIAL SYNC: Tell the cloud exactly what the hardware is doing right now
    client.publish(T_IP, get_ip_address(), retain=True)
    client.publish(T_HEATER, "ON" if GPIO.input(RELAY_PIN) else "OFF", retain=True)
    client.publish(T_TUNNEL, get_ssh_status(), retain=True)
    print(f"ðŸ”„ Reboot Sync: SSH is {get_ssh_status()}, Heater is {'ON' if GPIO.input(RELAY_PIN) else 'OFF'}")

def on_message(client, userdata, msg):
    payload = msg.payload.decode()
    topic = msg.topic
    
    # 1. Relay Control
    if topic == T_HEATER:
        GPIO.output(RELAY_PIN, GPIO.HIGH if payload == "ON" else GPIO.LOW)
        print(f"ðŸ”¥ Heater Command: {payload}")

    # 2. SSH Tunnel Control
    elif topic == T_TUNNEL:
        action = "start" if payload == "ON" else "stop"
        subprocess.run(["sudo", "systemctl", action, "cloudflared"])
        print(f"ðŸ›  SSH Tunnel Command: {action}")

    # 3. Manual Camera Trigger
    elif topic == T_CAMERA and payload == "SNAP":
        capture_and_send_photo(client)

# --- STARTUP ---
client = mqtt.Client(mqtt.CallbackAPIVersion.VERSION2)
client.username_pw_set(AIO_USERNAME, AIO_KEY)
client.on_connect = on_connect
client.on_message = on_message

client.connect("io.adafruit.com", 1883, 60)
client.loop_start()

last_photo_time = time.time()

# --- MAIN LOOP ---
print("ðŸš€ Miles Heater Controller Active. Monitoring every 60s...")
try:
    while True:
        now = time.time()

        # 1. Standard Heartbeat
        client.publish(T_SIGNAL, get_cellular_signal())
        client.publish(T_TEMP1, get_cpu_temp())
        client.publish(T_TEMP2, 0.0)
        client.publish(T_TEMP3, 0.0)
        client.publish(T_IP, get_ip_address(), retain=True)

        # 2. Scheduled 4-Hour Photo
        if now - last_photo_time >= PHOTO_INTERVAL:
            print("ðŸ•’ Timer Trigger: Automatic 4-hour capture.")
            capture_and_send_photo(client)
            last_photo_time = now

        time.sleep(HEARTBEAT_INTERVAL)

except KeyboardInterrupt:
    print("ðŸ›‘ Shutting down...")
    GPIO.cleanup()
    client.loop_stop()
