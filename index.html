<!DOCTYPE html>
<html>
<head>
    <title>Miles Control Center</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Fixed layout to prevent infinite scrolling */
        body { font-family: sans-serif; background: #121212; color: white; text-align: center; margin: 0; padding: 10px; overflow-x: hidden; }
        .card { background: #1e1e1e; padding: 15px; border-radius: 15px; max-width: 500px; margin: 0 auto 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .stat-box { background: #2a2a2a; padding: 10px; border-radius: 10px; text-align: left; }
        .stat-val { font-size: 18px; font-weight: bold; color: #fff; }
        .stat-lbl { font-size: 9px; color: #888; text-transform: uppercase; }
        .btn { display: block; width: 100%; margin: 8px 0; padding: 12px; font-size: 14px; font-weight: bold; border-radius: 8px; border: none; color: white; cursor: pointer; }
        .btn-heat { background: #ff4500; }
        .btn-ac { background: #007bff; }
        /* Fixed height for log to prevent page expansion */
        #command-log { height: 80px; overflow-y: auto; background: #000; color: #0f0; font-family: monospace; padding: 8px; text-align: left; border-radius: 8px; font-size: 10px; margin-top: 10px; border: 1px solid #333; }
    </style>
</head>
<body>

    <div class="card">
        <h3 style="color:#888; margin:0 0 10px 0;">SYSTEM STATUS</h3>
        <div class="grid">
            <div class="stat-box"><div class="stat-lbl">PI TEMP (T1)</div><div class="stat-val" id="disp-temp">--°F</div></div>
            <div class="stat-box"><div class="stat-lbl">CELL SIGNAL</div><div class="stat-val" id="disp-signal">--%</div></div>
            <div class="stat-box"><div class="stat-lbl">LOCAL IP</div><div class="stat-val" id="disp-ip" style="font-size:12px;">--</div></div>
            <div class="stat-box"><div class="stat-lbl">LAST PACKET</div><div class="stat-val" id="disp-time" style="font-size:12px;">--</div></div>
        </div>
        <button class="btn btn-heat" onclick="pub('relay-heater', 'ON')">ACTIVATE HEATER</button>
        <button class="btn btn-ac" onclick="pub('relay-heater', 'OFF')">ACTIVATE AC (HEATER OFF)</button>
    </div>

    <div class="card">
        <h3 style="color:#888; margin:0 0 5px 0;">TEMPERATURE (1H)</h3>
        <canvas id="tempChart" style="max-height:180px;"></canvas>
    </div>

    <div class="card">
        <h3 style="color:#888; margin:0 0 10px 0;">SERVICE CONTROLS</h3>
        <div style="display: flex; gap: 8px;">
            <button class="btn" style="background:#444;" onclick="pub('tunnel', 'ON')">START SSH</button>
            <button class="btn" style="background:#222;" onclick="pub('tunnel', 'OFF')">STOP SSH</button>
        </div>
        <div id="command-log">> UI Ready...</div>
    </div>

<script>
    const AIO_USER = "Jonalli0124";
    const AIO_KEY = "6c8ce060af344d95afc44350ecfd279d";
    const FEEDS = ["temp-1", "temp-2", "temp-3"];

    // 1. Initialize Graph
    const ctx = document.getElementById('tempChart').getContext('2d');
    const tempChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                { label: 'T1', borderColor: '#ff4500', data: [], tension: 0.2, pointRadius: 0, borderWidth: 2 },
                { label: 'T2', borderColor: '#007bff', data: [], tension: 0.2, pointRadius: 0, borderWidth: 1 },
                { label: 'T3', borderColor: '#28a745', data: [], tension: 0.2, pointRadius: 0, borderWidth: 1 }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { x: { display: false }, y: { grid: { color: '#333' }, ticks: { color: '#666', size: 10 } } },
            plugins: { legend: { labels: { color: '#888', boxWidth: 8, font: { size: 10 } } } }
        }
    });

    // 2. Fetch History - Optimized to prevent loops
    async function fetchHistory() {
        for (let i = 0; i < FEEDS.length; i++) {
            try {
                const url = `https://io.adafruit.com/api/v2/${AIO_USER}/feeds/${FEEDS[i]}/data?hours=1`;
                const resp = await fetch(url, { headers: {'X-AIO-Key': AIO_KEY} });
                const data = await resp.json();
                const points = data.reverse();
                
                points.forEach(p => {
                    tempChart.data.datasets[i].data.push(parseFloat(p.value));
                    if(i === 0) {
                        const ts = new Date(p.created_at).toLocaleTimeString([], {hour12:false});
                        tempChart.data.labels.push(ts);
                    }
                });
            } catch(e) { console.error("History sync failed for " + FEEDS[i]); }
        }
        tempChart.update();
    }

    // 3. MQTT
    const client = new Paho.MQTT.Client("io.adafruit.com", 443, "web_" + Math.random());
    client.connect({ useSSL: true, userName: AIO_USER, password: AIO_KEY, onSuccess: () => {
        client.subscribe(AIO_USER + "/feeds/#");
        fetchHistory();
    }});

    client.onMessageArrived = (msg) => {
        const payload = msg.payloadString;
        const topic = msg.destinationName;
        const now = new Date().toLocaleTimeString([], {hour12: false});

        if(topic.endsWith("temp-1")) {
            document.getElementById("disp-temp").innerText = payload + "°F";
            pushToGraph(0, payload, now);
        } else if(topic.endsWith("temp-2")) { pushToGraph(1, payload, now);
        } else if(topic.endsWith("temp-3")) { pushToGraph(2, payload, now);
        } else if(topic.endsWith("signal")) { document.getElementById("disp-signal").innerText = payload + "%";
        } else if(topic.endsWith("ip-address")) { document.getElementById("disp-ip").innerText = payload; }
        
        document.getElementById("disp-time").innerText = now;
    };

    function pushToGraph(idx, val, time) {
        tempChart.data.datasets[idx].data.push(parseFloat(val));
        if(idx === 0) tempChart.data.labels.push(time);
        if(tempChart.data.labels.length > 60) {
            tempChart.data.labels.shift();
            tempChart.data.datasets.forEach(d => d.data.shift());
        }
        tempChart.update('none');
    }

    function pub(feed, cmd) {
        let m = new Paho.MQTT.Message(cmd);
        m.destinationName = `${AIO_USER}/feeds/${feed}`;
        client.send(m);
        const log = document.getElementById("command-log");
        log.innerHTML = `<div>> ${cmd} -> ${feed}</div>` + log.innerHTML;
        // Auto-scroll log to top
        log.scrollTop = 0;
    }
</script>
</body>
</html>
