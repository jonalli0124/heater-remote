<!DOCTYPE html>
<html>
<head>
    <title>Miles Control | Historical Graph</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: white; text-align: center; margin: 0; padding: 20px; }
        .card { background: #2d2d2d; padding: 15px; border-radius: 15px; max-width: 600px; margin: 10px auto; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-box { background: #3a3a3a; padding: 10px; border-radius: 10px; }
        .stat-val { font-size: 22px; font-weight: bold; color: #fff; }
        .stat-lbl { font-size: 10px; color: #888; text-transform: uppercase; }
    </style>
</head>
<body>

    <div class="card">
        <h3 style="color:#888;">REAL-TIME STATUS</h3>
        <div class="grid">
            <div class="stat-box"><div class="stat-lbl">PI TEMP (T1)</div><div class="stat-val" id="disp-temp">--°F</div></div>
            <div class="stat-box"><div class="stat-lbl">SIGNAL</div><div class="stat-val" id="disp-signal">--%</div></div>
            <div class="stat-box"><div class="stat-lbl">LOCAL IP</div><div class="stat-val" id="disp-ip" style="font-size:14px;">--</div></div>
            <div class="stat-box"><div class="stat-lbl">UPDATED</div><div class="stat-val" id="disp-time" style="font-size:14px;">--</div></div>
        </div>
    </div>

    <div class="card">
        <h3 style="color:#888;">LAST HOUR HISTORY</h3>
        <canvas id="tempChart" style="height:250px;"></canvas>
    </div>

<script>
    const AIO_USER = "Jonalli0124";
    const AIO_KEY = "6c8ce060af344d95afc44350ecfd279d";
    const FEEDS = ["temp-1", "temp-2", "temp-3"];

    // 1. Setup Chart
    const ctx = document.getElementById('tempChart').getContext('2d');
    const tempChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                { label: 'Pi CPU', borderColor: '#ff4500', data: [], tension: 0.3, pointRadius: 0 },
                { label: 'Probe 2', borderColor: '#007bff', data: [], tension: 0.3, pointRadius: 0 },
                { label: 'Probe 3', borderColor: '#28a745', data: [], tension: 0.3, pointRadius: 0 }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { x: { display: false }, y: { grid: { color: '#444' }, ticks: { color: '#888' } } },
            plugins: { legend: { labels: { color: '#aaa' } } }
        }
    });

    // 2. Fetch Historical Data (Last 1 Hour)
    async function fetchHistory() {
        console.log("Fetching last hour of data...");
        for (let i = 0; i < FEEDS.length; i++) {
            // Using Adafruit IO API to get last 60 mins
            const url = `https://io.adafruit.com/api/v2/${AIO_USER}/feeds/${FEEDS[i]}/data?hours=1`;
            const resp = await fetch(url, { headers: {'X-AIO-Key': AIO_KEY} });
            const data = await resp.json();
            
            // Reverse so oldest data is first for the graph
            const points = data.reverse();
            points.forEach(p => {
                tempChart.data.datasets[i].data.push(parseFloat(p.value));
                if(i === 0) {
                    const ts = new Date(p.created_at).toLocaleTimeString([], {hour12:false});
                    tempChart.data.labels.push(ts);
                }
            });
        }
        tempChart.update();
    }

    // 3. Setup MQTT for Real-time
    const client = new Paho.MQTT.Client("io.adafruit.com", 443, "web_" + Math.random());
    
    client.connect({ useSSL: true, userName: AIO_USER, password: AIO_KEY, onSuccess: () => {
        client.subscribe(AIO_USER + "/feeds/#");
        fetchHistory(); // Load history once connected
    }});

    client.onMessageArrived = (msg) => {
        const payload = msg.payloadString;
        const topic = msg.destinationName;
        const now = new Date().toLocaleTimeString([], {hour12: false});

        if(topic.endsWith("temp-1")) {
            document.getElementById("disp-temp").innerText = payload + "°F";
            pushToGraph(0, payload, now);
        } else if(topic.endsWith("temp-2")) { pushToGraph(1, payload, now);
        } else if(topic.endsWith("temp-3")) { pushToGraph(2, payload, now);
        } else if(topic.endsWith("signal")) { document.getElementById("disp-signal").innerText = payload + "%";
        } else if(topic.endsWith("ip-address")) { document.getElementById("disp-ip").innerText = payload; }
        
        document.getElementById("disp-time").innerText = now;
    };

    function pushToGraph(idx, val, time) {
        tempChart.data.datasets[idx].data.push(parseFloat(val));
        if(idx === 0) tempChart.data.labels.push(time);
        
        // Maintain 60-point window (approx 1 hour)
        if(tempChart.data.labels.length > 60) {
            tempChart.data.labels.shift();
            tempChart.data.datasets.forEach(d => d.data.shift());
        }
        tempChart.update('none');
    }
</script>
</body>
</html>
